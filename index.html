<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kosetsu Gallery</title>
  <meta name="description" content="A single-file, IG-style image gallery with multi-tag filtering, lazy-loading, and a floating lightbox. Perfect for GitHub Pages."/>

  <style>
    :root{
      --bg:#0f0f10;
      --card:#111214;
      --muted:#a1a1aa;
      --text:#f5f5f6;
      --chip:#1a1b1e;
      --chip-active:#2563eb;
      --accent:#60a5fa;
      --border:#222327;
      --shadow: 0 6px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:14px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
    }

    /* Top bar (simple IG-ish) */
    .topbar{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(to bottom, rgba(15,15,16,.9), rgba(15,15,16,.8));
      backdrop-filter:saturate(160%) blur(6px);
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1100px; margin:0 auto; padding:10px 16px;
      display:flex; align-items:center; gap:12px; justify-content:space-between;
    }
    .brand{
      display:flex; align-items:center; gap:10px; font-weight:700;
      letter-spacing:.3px;
    }
    .brand .dot{ width:10px; height:10px; border-radius:999px; background:var(--accent); box-shadow:0 0 24px rgba(96,165,250,.9);}
    .hint{ color:var(--muted); font-size:12px }
    
    /* Controls */
    .controls{
      max-width:1100px; margin:10px auto 0; padding:0 16px 10px;
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
    }
    .chip{
      user-select:none; cursor:pointer; border:1px solid var(--border); background:var(--chip); color:var(--text);
      padding:6px 10px; border-radius:999px; transition:transform .06s ease, background .15s ease;
      display:inline-flex; align-items:center; gap:6px; white-space:nowrap;
    }
    .chip:hover{ transform:translateY(-1px) }
    .chip.active{ background:var(--chip-active); border-color:transparent }
    .chip[aria-pressed="true"]{ background:var(--chip-active) }
    .chip .x{ font-weight:700; opacity:.85 }
    .chip.reset{ background:#ef44441a; border-color:#ef44444a }
    .chip.mode{ background:#22c55e1a; border-color:#22c55e4a }
    .spacer{ flex:1 1 auto }
    .count{ color:var(--muted); font-size:12px}

    /* Grid */
    .grid{
      max-width:1100px; margin:6px auto 80px; padding:0 8px 0 12px; /* optical */
      display:grid; gap:4px;
      grid-template-columns:repeat(3, 1fr);
    }
    @media(min-width:640px){ .grid{ grid-template-columns:repeat(4, 1fr);} }
    @media(min-width:1024px){ .grid{ grid-template-columns:repeat(6, 1fr);} }

    .card{
      position:relative; background:var(--card); border-radius:6px; overflow:hidden;
      aspect-ratio:1/1; border:1px solid var(--border);
    }
    .card img{
      width:100%; height:100%; object-fit:cover; display:block; filter:blur(12px); transform:scale(1.02);
      transition:filter .35s ease, transform .4s ease;
    }
    .card img.ready{ filter:blur(0); transform:scale(1); }
    .card .overlay{
      position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(to bottom, rgba(0,0,0,.0), rgba(0,0,0,.35));
      opacity:0; transition:opacity .2s ease;
      font-weight:600; letter-spacing:.3px;
    }
    .card:hover .overlay{ opacity:1 }

    /* Lightbox (floating overlay, no page change) */
    .lightbox{
      position:fixed; inset:0; z-index:100;
      display:none; align-items:center; justify-content:center;
      padding:24px;
      background:rgba(0,0,0,.75);
    }
    .lightbox.open{ display:flex; }
    .lb-inner{
      position:relative;
      max-width:min(92vw, 1200px);
      max-height:86vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:12px;
    }
    .lb-img{
      max-width:100%;
      max-height:72vh;
      border-radius:10px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      background:#0b0b0c;
    }
    .lb-info{
      width:100%;
      background:rgba(17,17,18,.92);
      color:var(--muted);
      font-size:15px;
      border-radius:10px;
      padding:10px 16px 8px 16px;
      box-shadow:0 2px 12px rgba(0,0,0,.18);
      text-align:center;
      pointer-events:none;
    }
    .lb-close, .lb-prev, .lb-next{
      position:absolute; top:50%; transform:translateY(-50%);
      background:rgba(17,17,18,.9); border:1px solid var(--border);
      color:var(--text); padding:10px 12px; border-radius:10px; cursor:pointer; user-select:none;
    }
    .lb-close{ top:-10px; right:-10px; transform:none; font-size:20px; padding:8px 10px; border-radius:999px; }
    .lb-prev{ left:-46px } .lb-next{ right:-46px }
    @media(max-width:640px){ .lb-prev{ left:4px } .lb-next{ right:4px } }

    .kbd{
      font:12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:#111; border:1px solid var(--border); padding:2px 6px; border-radius:6px; color:#ddd;
    }

    /* Footer note */
    footer{ max-width:1100px; margin:20px auto 60px; padding:0 16px; color:var(--muted); font-size:12px; text-align: center; }
    a{ color:var(--accent); text-decoration:none }
    a:hover{ text-decoration:underline }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot" aria-hidden="true"></span>
        <span>Kosetsu Gallery</span>
      </div>
      <div class="hint">
        點圖看大圖（<span class="kbd">Esc</span> 關閉，<span class="kbd">←</span>/<span class="kbd">→</span> 切換）
      </div>
    </div>
  </header>

  <section class="controls" id="controls">
    <!-- Tags (auto-generated) -->
    <button class="chip reset" id="resetBtn" title="清除所有篩選">還原</button>
    <button class="chip mode" id="modeBtn" title="切換 ALL / ANY 篩選模式">Match: <strong id="modeLabel">ALL</strong></button>
    <span class="spacer" aria-hidden="true"></span>
    <div class="count"><span id="shownCount">0</span> / <span id="totalCount">0</span> 顯示</div>
  </section>

  <main class="grid" id="grid" aria-live="polite"></main>

  <footer>
    <p>Copyright © 2025 香雪花間. All rights reserved.</p>
  </footer>

  <script>
    /* ======== 1) 你的圖片清單（示例） ========
       - thumb: 清單頁顯示的縮圖
       - full : 點擊後顯示的大圖（若沒有可與 thumb 相同）
       - tags : 多個字串標籤，用於篩選
       TODO: 換成你的實際檔案路徑
    */
    const dataString = `[{"thumb":"./images/thumbs/87ac5125-2a94-4d63-9ae4-0fc179ed0594.webp","full":"./images/full/87ac5125-2a94-4d63-9ae4-0fc179ed0594.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/867cdbbc-9737-44f7-afef-ace0506eaa5d.webp","full":"./images/full/867cdbbc-9737-44f7-afef-ace0506eaa5d.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/1de0e192-17cc-41d9-b746-f68d3a06add4.webp","full":"./images/full/1de0e192-17cc-41d9-b746-f68d3a06add4.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/4afa9785-1545-44da-8a03-d400ee32c1b4.webp","full":"./images/full/4afa9785-1545-44da-8a03-d400ee32c1b4.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/6441621a-b020-49fd-9287-2c237b6da7cb.webp","full":"./images/full/6441621a-b020-49fd-9287-2c237b6da7cb.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/1cdcab65-940a-40a7-8557-acee8b8a8aae.webp","full":"./images/full/1cdcab65-940a-40a7-8557-acee8b8a8aae.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/e0212b9b-4ea1-4dfe-9e03-f229d995f3c8.webp","full":"./images/full/e0212b9b-4ea1-4dfe-9e03-f229d995f3c8.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/156e7fbf-316f-40f5-aa36-e8f213d3d62e.webp","full":"./images/full/156e7fbf-316f-40f5-aa36-e8f213d3d62e.png","tags":["和服","振袖"],"alt":""},{"thumb":"./images/thumbs/a4ebb920-f0c3-4d98-a8c0-9370ce5b8555.webp","full":"./images/full/a4ebb920-f0c3-4d98-a8c0-9370ce5b8555.png","tags":["和服"],"alt":""},{"thumb":"./images/thumbs/4b933269-e3cc-468e-b556-f6f01c4babcb.webp","full":"./images/full/4b933269-e3cc-468e-b556-f6f01c4babcb.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/6801261a-50d5-43ab-b602-e52135ce5a97.webp","full":"./images/full/6801261a-50d5-43ab-b602-e52135ce5a97.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/43a69d1e-a7cd-49e1-95c3-b0d52762ce72.webp","full":"./images/full/43a69d1e-a7cd-49e1-95c3-b0d52762ce72.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/57794970-8214-4ae1-bf58-c5e383c1bab2.webp","full":"./images/full/57794970-8214-4ae1-bf58-c5e383c1bab2.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/9fb2c8a0-4cd2-41c8-b5fd-47629a0bf524.webp","full":"./images/full/9fb2c8a0-4cd2-41c8-b5fd-47629a0bf524.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/6b9eecd9-985b-4b02-a7ac-bdbd7b453b2d.webp","full":"./images/full/6b9eecd9-985b-4b02-a7ac-bdbd7b453b2d.jpg","tags":["漢服","月季之間","1200","七月夕","宋","清月"],"alt":""},{"thumb":"./images/thumbs/69e3e8fc-6153-4140-ab21-b9e5b2865f5c.webp","full":"./images/full/69e3e8fc-6153-4140-ab21-b9e5b2865f5c.png","tags":["漢服","芍藥之間","1500","十三余","宋","花熏扇面"],"alt":""},{"thumb":"./images/thumbs/e3a20681-7e24-459a-84cd-179c6de5d63d.webp","full":"./images/full/e3a20681-7e24-459a-84cd-179c6de5d63d.jpg","tags":["漢服","月季之間","1200","七月夕","明","青霧"],"alt":""},{"thumb":"./images/thumbs/bd5e551a-17ca-4444-b869-664d82cea0c9.webp","full":"./images/full/bd5e551a-17ca-4444-b869-664d82cea0c9.png","tags":["和服","訪問着"],"alt":""},{"thumb":"./images/thumbs/2900c722-413c-45ec-b03e-d052ef60b2e6.webp","full":"./images/full/2900c722-413c-45ec-b03e-d052ef60b2e6.jpg","tags":["漢服","松柏之間","1500","十三余","宋","千里逍遙","男款"],"alt":""},{"thumb":"./images/thumbs/450ca45b-7640-4bb3-aaaf-c2031ad5cd13.webp","full":"./images/full/450ca45b-7640-4bb3-aaaf-c2031ad5cd13.jpg","tags":["漢服","芍藥之間","1500","十三余","宋","玉蘭清露"],"alt":""},{"thumb":"./images/thumbs/6d015e5f-1e81-4f08-add1-38eff0493ca6.webp","full":"./images/full/6d015e5f-1e81-4f08-add1-38eff0493ca6.jpg","tags":["漢服","月季之間","1200","十三余","宋","玫瑰酸梅湯"],"alt":""},{"thumb":"./images/thumbs/ab2dc86a-6dd6-49ba-90f6-c6b0da3a282a.webp","full":"./images/full/ab2dc86a-6dd6-49ba-90f6-c6b0da3a282a.jpg","tags":["漢服","月季之間","1200","十三余","宋","花月之神"],"alt":""},{"thumb":"./images/thumbs/db6f97c8-d0a0-4dc7-bb5f-c323f024afeb.webp","full":"./images/full/db6f97c8-d0a0-4dc7-bb5f-c323f024afeb.jpg","tags":["漢服","菡萏之間","800","十三余","宋","美人紗"],"alt":""},{"thumb":"./images/thumbs/bdeb7323-f623-4296-88a5-cf5f5708ce71.webp","full":"./images/full/bdeb7323-f623-4296-88a5-cf5f5708ce71.jpg","tags":["漢服","月季之間","1200","十三余","宋","庭蕪梅"],"alt":""},{"thumb":"./images/thumbs/3c15a963-f996-4c56-ab13-cd1b000f8a74.webp","full":"./images/full/3c15a963-f996-4c56-ab13-cd1b000f8a74.jpg","tags":["漢服","菡萏之間","800","十三余","宋","桑菊茶"],"alt":""},{"thumb":"./images/thumbs/76949760-cc69-439c-a9f4-d716fa79abd2.webp","full":"./images/full/76949760-cc69-439c-a9f4-d716fa79abd2.jpg","tags":["漢服","芍藥之間","1500","十三余","宋","晗光玉蕊"],"alt":""},{"thumb":"./images/thumbs/ea2131b3-e836-4e41-8914-32e2bf78e594.webp","full":"./images/full/ea2131b3-e836-4e41-8914-32e2bf78e594.jpg","tags":["漢服","月季之間","1200","十三余","宋","清波芙蕖"],"alt":""},{"thumb":"./images/thumbs/895dfb2e-5c29-47b5-83ee-20f07c4f33a5.webp","full":"./images/full/895dfb2e-5c29-47b5-83ee-20f07c4f33a5.jpg","tags":["漢服","芍藥之間","1500","十三余","宋","琵琶歌引"],"alt":""},{"thumb":"./images/thumbs/24a51146-45f8-4957-9e5e-03b34f66ba45.webp","full":"./images/full/24a51146-45f8-4957-9e5e-03b34f66ba45.jpg","tags":["漢服","月季之間","1200","十三余","宋","雲曦朱影"],"alt":""},{"thumb":"./images/thumbs/966fc396-1c3d-4652-ad3a-49398434e17b.webp","full":"./images/full/966fc396-1c3d-4652-ad3a-49398434e17b.jpg","tags":["漢服","菡萏之間","800","十三余","宋","撲蝶會"],"alt":""},{"thumb":"./images/thumbs/06118605-7d5a-4998-bd03-cb4e49747381.webp","full":"./images/full/06118605-7d5a-4998-bd03-cb4e49747381.jpg","tags":["漢服","芍藥之間","1500","十三余","宋","蓮生"],"alt":""},{"thumb":"./images/thumbs/d83e434d-6eaa-48ab-9c59-63b4537c0baf.webp","full":"./images/full/d83e434d-6eaa-48ab-9c59-63b4537c0baf.jpg","tags":["漢服","菡萏之間","800","十三余","宋","靈芝仙"],"alt":""},{"thumb":"./images/thumbs/53009226-6c0c-4471-9048-f404dedbf2fc.webp","full":"./images/full/53009226-6c0c-4471-9048-f404dedbf2fc.jpg","tags":["漢服","月季之間","1200","十三余","明","山色圖"],"alt":""},{"thumb":"./images/thumbs/8ea15e29-fb73-469f-b551-abe878b231cd.webp","full":"./images/full/8ea15e29-fb73-469f-b551-abe878b231cd.jpg","tags":["漢服","菡萏之間","800","十三余","明","天欲雪"],"alt":""},{"thumb":"./images/thumbs/7a490875-9907-4c1b-ba2d-ac586f45de91.webp","full":"./images/full/7a490875-9907-4c1b-ba2d-ac586f45de91.jpg","tags":["漢服","菡萏之間","800","十三余","明","金玉桑菊"],"alt":""},{"thumb":"./images/thumbs/1e765cc2-740f-4cb5-b298-2ba055673b1b.webp","full":"./images/full/1e765cc2-740f-4cb5-b298-2ba055673b1b.jpg","tags":["漢服","菡萏之間","800","十三余","明","落英"],"alt":""},{"thumb":"./images/thumbs/1bddeb58-e637-4540-87bf-5838559fea71.webp","full":"./images/full/1bddeb58-e637-4540-87bf-5838559fea71.jpg","tags":["漢服","月季之間","1200","十三余","明","歸夢星影"],"alt":""},{"thumb":"./images/thumbs/655323a8-db70-4b9a-bba4-1a6b1c6df526.webp","full":"./images/full/655323a8-db70-4b9a-bba4-1a6b1c6df526.jpg","tags":["漢服","菡萏之間","800","十三余","唐","飛天樂"],"alt":""},{"thumb":"./images/thumbs/bdad3f17-c77d-4db9-88af-6de20a8a06ad.webp","full":"./images/full/bdad3f17-c77d-4db9-88af-6de20a8a06ad.jpg","tags":["漢服","菡萏之間","800","十三余","唐","碧霄美人"],"alt":""},{"thumb":"./images/thumbs/a0f8f248-c7d4-45c2-8e92-aa767c915510.webp","full":"./images/full/a0f8f248-c7d4-45c2-8e92-aa767c915510.jpg","tags":["漢服","芍藥之間","1500","十三余","漢","藍香雪"],"alt":""},{"thumb":"./images/thumbs/0a421d3d-04fc-403d-a963-eaff9f63533f.webp","full":"./images/full/0a421d3d-04fc-403d-a963-eaff9f63533f.jpg","tags":["漢服","海棠之間","600","玉术","唐","繁花拂面"],"alt":""},{"thumb":"./images/thumbs/323fc9e1-6021-457b-81cc-e0709f782a26.webp","full":"./images/full/323fc9e1-6021-457b-81cc-e0709f782a26.jpg","tags":["漢服","松柏之間","如夢霓裳","明","水龍吟(雙色)","800"],"alt":""},{"thumb":"./images/thumbs/37b1a9f8-c7a0-4c20-b6b2-d054058b21a7.webp","full":"./images/full/37b1a9f8-c7a0-4c20-b6b2-d054058b21a7.jpg","tags":["漢服","菡萏之間","800","有香如故","漢元素","一念關山"],"alt":""},{"thumb":"./images/thumbs/6d67fa43-a6ac-4da3-936a-bb2982494928.webp","full":"./images/full/6d67fa43-a6ac-4da3-936a-bb2982494928.jpg","tags":["漢服","菡萏之間","800","池夏","明","金陵往事(瓊鳳吟)"],"alt":""},{"thumb":"./images/thumbs/d84a8054-546b-408c-8559-76c4cce2dea9.webp","full":"./images/full/d84a8054-546b-408c-8559-76c4cce2dea9.jpg","tags":["漢服","芍藥之間","1500","明鏡華服","唐","唐宮春䁱(長安)"],"alt":""},{"thumb":"./images/thumbs/0e96f845-5de6-4a73-9bb7-354e1b68c698.webp","full":"./images/full/0e96f845-5de6-4a73-9bb7-354e1b68c698.jpg","tags":["漢服","海棠之間","600","花仙記","唐","海棠春宴(雙色)"],"alt":""},{"thumb":"./images/thumbs/35c1a078-abcb-4483-9b3d-a770a6750583.webp","full":"./images/full/35c1a078-abcb-4483-9b3d-a770a6750583.jpg","tags":["漢服","海棠之間","600","花朝記","明","燕居圖"],"alt":""},{"thumb":"./images/thumbs/27bf511b-3337-421a-a776-4c2b587ef0bd.webp","full":"./images/full/27bf511b-3337-421a-a776-4c2b587ef0bd.jpg","tags":["漢服","海棠之間","600","青衣初見","唐","桔梗"],"alt":""},{"thumb":"./images/thumbs/a9017b82-9d37-40c3-9c09-125f0723271d.webp","full":"./images/full/a9017b82-9d37-40c3-9c09-125f0723271d.jpg","tags":["漢服","菡萏之間","800","重回漢唐","宋","朝花夕拾"],"alt":""},{"thumb":"./images/thumbs/a82b6729-a1f9-452a-a3c7-d600ca70a442.webp","full":"./images/full/a82b6729-a1f9-452a-a3c7-d600ca70a442.jpg","tags":["漢服","海棠之間","600","重回漢唐","唐","芳華"],"alt":""},{"thumb":"./images/thumbs/4a298bf8-a2c7-4df3-8275-19775a0b1411.webp","full":"./images/full/4a298bf8-a2c7-4df3-8275-19775a0b1411.jpg","tags":["漢服","海棠之間","600","重回漢唐","唐","素婉(三色)"],"alt":""},{"thumb":"./images/thumbs/81bbee34-b070-4d0b-8d55-a08f6c3d9fcb.webp","full":"./images/full/81bbee34-b070-4d0b-8d55-a08f6c3d9fcb.jpg","tags":["漢服","松柏之間","風雅司制","宋","曼殊絲語","600"],"alt":""},{"thumb":"./images/thumbs/3102fab5-b263-41ca-b949-5512eb1c9b40.webp","full":"./images/full/3102fab5-b263-41ca-b949-5512eb1c9b40.jpg","tags":["漢服","海棠之間","600","宴山亭","唐","朱砂"],"alt":""},{"thumb":"./images/thumbs/7cfa6bdc-11b3-4a81-817d-b82669edbdae.webp","full":"./images/full/7cfa6bdc-11b3-4a81-817d-b82669edbdae.jpg","tags":["漢服","菡萏之間","800","栗芝堂","唐","婆羅雙姝"],"alt":""},{"thumb":"./images/thumbs/63721ff9-a903-43bb-a210-818816bb5181.webp","full":"./images/full/63721ff9-a903-43bb-a210-818816bb5181.jpg","tags":["漢服","海棠之間","600","桔嶼","宋","晴光霽曉"],"alt":""},{"thumb":"./images/thumbs/4ef792c9-5b0a-4706-ab76-54210b289f60.webp","full":"./images/full/4ef792c9-5b0a-4706-ab76-54210b289f60.jpg","tags":["漢服","海棠之間","600","桔嶼","明","樓蘭"],"alt":""},{"thumb":"./images/thumbs/248dc104-7411-4b49-a26b-770330df874d.webp","full":"./images/full/248dc104-7411-4b49-a26b-770330df874d.jpg","tags":["漢服","海棠之間","600","桔嶼","唐","陽春白雪"],"alt":""},{"thumb":"./images/thumbs/e8c9f9ad-94df-405f-a286-11a737f5f8ac.webp","full":"./images/full/e8c9f9ad-94df-405f-a286-11a737f5f8ac.jpg","tags":["漢服","海棠之間","600","桔嶼","唐","簪花(雙色)"],"alt":""},{"thumb":"./images/thumbs/14a5e466-af1d-4ead-b1b0-65068097e96b.webp","full":"./images/full/14a5e466-af1d-4ead-b1b0-65068097e96b.jpg","tags":["漢服","芍藥之間","1500","涂七七","唐","錦瑟年華"],"alt":""},{"thumb":"./images/thumbs/e0930625-0c11-48e6-9efb-8965a94eceda.webp","full":"./images/full/e0930625-0c11-48e6-9efb-8965a94eceda.jpg","tags":["漢服","松柏之間","尋錄","明","刺詔","1200"],"alt":""},{"thumb":"./images/thumbs/83f59e34-05cf-46ae-aa5a-36bba6ef8dd1.webp","full":"./images/full/83f59e34-05cf-46ae-aa5a-36bba6ef8dd1.jpg","tags":["漢服","菡萏之間","800","無衣飲羽","唐","鮫人淚"],"alt":""},{"thumb":"./images/thumbs/b49baaaf-991e-46f3-9133-56f7ff1c3859.webp","full":"./images/full/b49baaaf-991e-46f3-9133-56f7ff1c3859.jpg","tags":["漢服","芍藥之間","1500","雲間山澤","唐","鳶尾"],"alt":""},{"thumb":"./images/thumbs/6d99c2cb-5740-42bf-b26f-c56ef5d5f605.webp","full":"./images/full/6d99c2cb-5740-42bf-b26f-c56ef5d5f605.jpg","tags":["漢服","菡萏之間","800","萬袖明宋衣莊","宋","如夢令"],"alt":""},{"thumb":"./images/thumbs/bb42fc4a-a563-4422-bfc4-6d13be5faa72.webp","full":"./images/full/bb42fc4a-a563-4422-bfc4-6d13be5faa72.jpg","tags":["漢服","月季之間","1200","七月夕","戰國袍","逍遙遊"],"alt":""},{"thumb":"./images/thumbs/b307c711-841b-4a87-b708-18d8a43ca77c.webp","full":"./images/full/b307c711-841b-4a87-b708-18d8a43ca77c.jpg","tags":["漢服","海棠之間","600","醉婉亭","唐","憐玉奴(雙色)"],"alt":""},{"thumb":"./images/thumbs/f9bb3732-b647-4836-abf8-f672a2979e09.webp","full":"./images/full/f9bb3732-b647-4836-abf8-f672a2979e09.jpg","tags":["漢服","海棠之間","600","靚朵韻","唐","妒殺"],"alt":""},{"thumb":"./images/thumbs/daebe82b-8b1e-4e6f-8440-4b8de40d5792.webp","full":"./images/full/daebe82b-8b1e-4e6f-8440-4b8de40d5792.jpg","tags":["漢服","海棠之間","600","靜還决","漢","祝余"],"alt":""},{"thumb":"./images/thumbs/65df7bc6-21aa-4326-be00-41db53994427.webp","full":"./images/full/65df7bc6-21aa-4326-be00-41db53994427.jpg","tags":["漢服","芍藥之間","1500","鍾靈記","宋","琉璃牡丹"],"alt":""},{"thumb":"./images/thumbs/6d17c05d-fc99-464d-9482-4034c690d698.webp","full":"./images/full/6d17c05d-fc99-464d-9482-4034c690d698.jpg","tags":["漢服","芍藥之間","1500","鍾靈記","明","行香子"],"alt":""},{"thumb":"./images/thumbs/fff2857e-b7b3-4320-8459-9efb4add0305.webp","full":"./images/full/fff2857e-b7b3-4320-8459-9efb4add0305.png","tags":["和服","振袖"],"alt":""}]`;
    const IMAGES = JSON.parse(dataString);

    /* ======== 2) 衍生所有標籤，建立篩選器 ======== */
    const allTags = Array.from(
      IMAGES.reduce((set, img) => { (img.tags||[]).forEach(t => set.add(t)); return set; }, new Set())
    ).sort((a,b)=> a.localeCompare(b));
    const selected = new Set();           // 當前選取的 tags
    let matchAll = true;                  // true=ALL(且), false=ANY(或)

    const grid = document.getElementById('grid');
    const controls = document.getElementById('controls');
    const resetBtn = document.getElementById('resetBtn');
    const modeBtn  = document.getElementById('modeBtn');
    const modeLabel= document.getElementById('modeLabel');
    const shownCountEl = document.getElementById('shownCount');
    const totalCountEl = document.getElementById('totalCount');

    function makeChip(tag){
      const btn = document.createElement('button');
      btn.className='chip';
      btn.type='button';
      btn.textContent = `#${tag}`;
      btn.setAttribute('aria-pressed','false');
      btn.dataset.tag=tag;
      btn.addEventListener('click', ()=>{
        if(selected.has(tag)){ selected.delete(tag); btn.setAttribute('aria-pressed','false'); btn.classList.remove('active');}
        else { selected.add(tag); btn.setAttribute('aria-pressed','true'); btn.classList.add('active');}
        updateFilter();
      });
      return btn;
    }

    // 插入 tags chips（reset/mode 按鈕右邊）
    const frag = document.createDocumentFragment();
    allTags.forEach(t => frag.appendChild(makeChip(t)));
    controls.insertBefore(frag, controls.querySelector('.spacer'));

    // 切換 ALL/ANY 模式
    modeBtn.addEventListener('click', ()=>{
      matchAll = !matchAll;
      modeLabel.textContent = matchAll ? 'ALL' : 'ANY';
      updateFilter();
    });

    // 還原
    resetBtn.addEventListener('click', ()=>{
      selected.clear();
      document.querySelectorAll('.chip[aria-pressed]').forEach(el => { el.setAttribute('aria-pressed','false'); el.classList.remove('active'); });
      if(!matchAll){ matchAll=true; modeLabel.textContent='ALL'; }
      updateFilter();
    });

    /* ======== 3) 建立卡片（IG-style 方形） ======== */
    const cards = IMAGES.map((img, idx)=>{
      const card = document.createElement('button');
      card.type='button';
      card.className='card';
      card.dataset.tags=(img.tags||[]).join(',');
      card.dataset.index=String(idx);
      const image = document.createElement('img');
      image.alt = img.alt || (img.tags||[]).join(', ') || 'photo';
      image.loading='lazy';
      image.decoding='async';
      image.dataset.src = img.thumb || img.full; // lazy src
      card.appendChild(image);

      const ov = document.createElement('div');
      ov.className='overlay';
      ov.textContent='點擊放大';
      card.appendChild(ov);

      card.addEventListener('click', ()=> openLightbox(idx));
      return card;
    });
    grid.append(...cards);
    totalCountEl.textContent = String(cards.length);

    /* ======== 4) 檢視過濾 ======== */
    function isMatch(tagsCsv){
      if(selected.size === 0) return true;
      const tags = tagsCsv ? tagsCsv.split(',') : [];
      if(matchAll){
        for(const s of selected){ if(!tags.includes(s)) return false; }
        return true;
      }else{
        for(const s of selected){ if(tags.includes(s)) return true; }
        return false;
      }
    }
    function updateFilter(){
      let shown=0;
      for(const c of cards){
        const ok = isMatch(c.dataset.tags);
        c.style.display = ok ? '' : 'none';
        if(ok) shown++;
      }
      shownCountEl.textContent = String(shown);
    }
    updateFilter();

    /* ======== 5) Lazy load + blur-up ======== */
    const io = new IntersectionObserver((entries)=>{
      for(const e of entries){
        if(e.isIntersecting){
          const img = e.target;
          const src = img.dataset.src;
          if(src && !img.dataset.loaded){
            img.src = src;
            img.addEventListener('load', ()=>{
              img.classList.add('ready');
              img.dataset.loaded='1';
            }, {once:true});
          }
          io.unobserve(img);
        }
      }
    }, { rootMargin:'200px 0px' });
    document.querySelectorAll('.card img').forEach(img => io.observe(img));

    /* ======== 6) Lightbox（浮層，不跳頁） ======== */
    let lbIndex = -1;
    const lb = document.createElement('div');
    lb.className='lightbox'; lb.setAttribute('role','dialog'); lb.setAttribute('aria-modal','true');
    lb.innerHTML = `
      <div class="lb-inner">
        <img class="lb-img" alt="">
        <div class="lb-info"></div>
        <button class="lb-close" title="關閉">✕</button>
        <button class="lb-prev" title="上一張">⟨</button>
        <button class="lb-next" title="下一張">⟩</button>
      </div>`;
    document.body.appendChild(lb);
    const lbImg = lb.querySelector('.lb-img');
    const lbInfo = lb.querySelector('.lb-info');
    const btnClose = lb.querySelector('.lb-close');
    const btnPrev = lb.querySelector('.lb-prev');
    const btnNext = lb.querySelector('.lb-next');

    function showIndex(i){
      lbIndex = (i + IMAGES.length) % IMAGES.length;
      const item = IMAGES[lbIndex];
      lbImg.src = item.full || item.thumb;
      lbImg.alt = item.alt || (item.tags||[]).join(', ');
      // 顯示替代文字和標籤
      let tags = (item.tags && item.tags.length) ? item.tags.map(t=>`<span style='background:var(--chip);color:var(--text);border-radius:8px;padding:2px 8px;margin:0 2px;'>#${t}</span>`).join('') : '<span style="color:var(--muted);">無標籤</span>';
      let alt = item.alt ? `<span style='font-weight:500;'>${item.alt}</span>` : '<span style="color:var(--muted);"></span>';
      lbInfo.innerHTML = `${alt}<br>${tags}`;
    }
    function openLightbox(i){
      showIndex(i);
      lb.classList.add('open');
      document.body.style.overflow='hidden';
    }
    function closeLightbox(){
      lb.classList.remove('open');
      document.body.style.overflow='';
      lbImg.src='';
    }
    function prev(){ showIndex(lbIndex-1) }
    function next(){ showIndex(lbIndex+1) }

    btnClose.addEventListener('click', closeLightbox);
    btnPrev.addEventListener('click', prev);
    btnNext.addEventListener('click', next);
    lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLightbox(); });

    document.addEventListener('keydown', (e)=>{
      if(!lb.classList.contains('open')) return;
      if(e.key === 'Escape') closeLightbox();
      else if(e.key === 'ArrowLeft') prev();
      else if(e.key === 'ArrowRight') next();
    });
  </script>
</body>
</html>
